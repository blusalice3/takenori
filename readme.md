# 即売会購入巡回表アプリ

即売会での購入リストを管理するWebアプリケーションです。タブレットやスマートフォン端末のホーム画面に追加してネイティブアプリのように使用できます。

## 📋 目次

- [概要](#概要)
- [主な機能](#主な機能)
- [技術スタック](#技術スタック)
- [プロジェクト構成](#プロジェクト構成)
- [セットアップ](#セットアップ)
- [使用方法](#使用方法)
- [データ管理](#データ管理)
- [対応環境](#対応環境)
- [開発者向け情報](#開発者向け情報)
- [ライセンス](#ライセンス)

## 概要

このアプリケーションは、即売会（コミケ、コミティアなど）での購入計画を効率的に管理するためのツールです。スプレッドシートから購入リストをインポートし、会場での巡回順序を最適化して、購入状況をリアルタイムで記録できます。

### 主な特徴

- **複数イベント管理**: 複数の即売会イベントを同時に管理可能
- **参加日別表示**: 参加日を分けて管理
- **編集モードと実行モード**: 事前計画と当日実行を切り替え可能
- **視認性の向上**: ブロック値ごとの色分けと購入状態の色表示により、会場での識別が容易
- **オフライン対応**: PWA対応により、インターネット接続なしでも動作
- **データの永続化**: ブラウザのlocalStorageに自動保存

## 主な機能

### 1. リストの作成とインポート

- **スプレッドシートURLからインポート**: GoogleスプレッドシートのURLを入力して自動インポート
  - ⚠️**重要**: 取込スプレッドシートの「ファイル」→「共有」→「他のユーザーと共有」→「一般的なアクセス」で「リンクを知っている全員」「閲覧者」に設定してください
  - シート名「品目表」のM列からR列とW列をインポート
  - M列（サークル名）、N列（参加日）、O列（ブロック）、P列（ナンバー）、Q列（タイトル）、R列（頒布価格）、W列（備考）
  - 配置情報（実行列/候補リスト）の保持

- **CSVファイルからインポート**: ローカルのCSVファイルをアップロード
  - A列からD列の値が全て入力されている行のみをインポート
  - A列（サークル名）、B列（参加日）、C列（ブロック）、D列（ナンバー）、E列（タイトル）、F列（頒布価格）、H列（備考）
  - または、M列から始まる形式（スプレッドシート形式）にも対応

- **手動入力**: タブ区切りテキストを貼り付けて一括登録、または個別にアイテムを追加
  - スプレッドシートのM列からR列とW列をコピーして「サークル名」欄に貼り付け（タブ区切りで自動振り分け）

### 2. アイテム管理

- **購入状態の管理**: 以下の6つの状態を切り替え可能
  - 未購入（None）
  - 購入済（Purchased）
  - 売切（SoldOut）
  - 欠席（Absent）
  - 後回し（Postpone）
  - 遅参（Late）

- **アイテムの編集・削除**: 個別アイテムの情報を編集・削除可能

- **アイテムの並び替え**: ドラッグ&ドロップで順序を自由に変更（自動スクロール機能付き）

- **ブロック値ごとの色分け**: 未購入のアイテムに対して、ブロック値ごとに異なる色系統を自動割り当て
  - 動的対応: インポート時や新規追加時に存在するブロック値の数に応じて、30色のパレットから自動的に色を割り当て
  - 縞模様表示: 同じブロック値のアイテム同士で隣り合った場合、濃い色と薄い色が交互に表示され、視認性を向上
  - 色相環最適化: 同系統の色が連続しないように色相環を考慮して配置し、隣り合う異なるブロック値でも見分けやすく設計

- **購入状態の色表示**: 購入済み・売切・欠席・後回し・遅参の各状態を、彩度を上げた色で表示し、状態を一目で識別可能

### 3. 編集モードと実行モード

#### 編集モード

- **2列表示**: 実行モード表示列（左）と候補リスト（右）に分けて表示
- **アイテムの移動**: 候補リストから実行モード表示列へアイテムを移動（またはその逆）
- **複数選択**: 複数のアイテムを選択して一括操作
- **並び替え**: 選択したアイテムをナンバー順にソート（昇順・降順切り替え可能）
- **ブロックソート**: ブロック名で候補リストをソート（昇順・降順切り替え可能）
- **ブロックフィルタ**: 候補リストをブロック値でフィルタリングして表示
- **ドラッグ&ドロップ**: アイテムをドラッグ&ドロップで並び替え（自動スクロール機能付き）

#### 実行モード

- **実行列のみ表示**: 実行モード表示列に移動したアイテムのみを表示
- **状態別フィルタ**: 巡回順、単品後回し、遅参、欠席、売切、購入済でフィルタリング
- **ブロックソート**: ブロック名でソート
- **サマリー表示**: 購入済み件数と残りの合計金額を表示

### 4. ソート機能

- **巡回順ソート**: 手動で並び替えた順序を維持
- **状態別ソート**: 購入状態でフィルタリング（巡回順、単品後回し、遅参、欠席、売切、購入済）
- **ブロックソート**: ブロック名で昇順・降順にソート（編集モード・実行モード両方で利用可能）
- **ナンバーソート**: 選択したアイテムをナンバー順にソート（一括操作、昇順・降順切り替え可能）
- **ブロックフィルタ**: 候補リストをブロック値でフィルタリング（編集モードのみ）

### 5. その他の機能

- **一括操作**: 複数アイテムの選択と一括ソート
- **ズーム機能**: 表示倍率を30%〜150%の範囲で調整
- **ダークモード対応**: システム設定に応じて自動切り替え
- **CSVエクスポート**: リストをCSV形式でダウンロード（実行列の順序を保持）
- **リスト更新**: スプレッドシートから変更を取得して自動更新（M列から始まる形式を使用）
- **リスト名変更**: 即売会の名称を変更
- **リスト削除**: 不要なリストを削除
- **長押し操作**: タブを500ms長押しで編集モードと実行モードを切り替え

## 技術スタック

### フロントエンド

- **React 18.3.1**: UIライブラリ
- **TypeScript 5.5.3**: 型安全性を提供
- **Vite 5.4.2**: ビルドツールと開発サーバー
- **Tailwind CSS**: ユーティリティファーストのCSSフレームワーク（CDN経由）

### PWA機能

- **vite-plugin-pwa 0.20.1**: PWA機能の実装
- **workbox-window 7.1.0**: サービスワーカーの管理

### データ保存

- **localStorage**: ブラウザのローカルストレージにデータを保存

## プロジェクト構成

```
event-shopping-planner-main/
├── src/
│   ├── App.tsx                    # メインアプリケーションコンポーネント
│   ├── index.tsx                  # エントリーポイント
│   ├── types.ts                   # TypeScript型定義
│   ├── components/
│   │   ├── ImportScreen.tsx      # インポート画面
│   │   ├── ShoppingList.tsx      # ショッピングリスト表示
│   │   ├── ShoppingItemCard.tsx   # アイテムカード
│   │   ├── EventListScreen.tsx    # イベントリスト画面
│   │   ├── SummaryBar.tsx         # サマリーバー（購入状況表示）
│   │   ├── ZoomControl.tsx         # ズームコントロール
│   │   ├── BulkActionControls.tsx # 一括操作コントロール
│   │   ├── DeleteConfirmationModal.tsx    # 削除確認モーダル
│   │   ├── UpdateConfirmationModal.tsx    # 更新確認モーダル
│   │   ├── UrlUpdateDialog.tsx     # URL更新ダイアログ
│   │   ├── EventRenameDialog.tsx  # イベント名変更ダイアログ
│   │   └── icons/                 # SVGアイコンコンポーネント
│   └── utils/
│       └── itemComparison.ts       # アイテム比較・ソート用ユーティリティ
├── index.html                      # HTMLエントリーポイント
├── package.json                    # 依存関係とスクリプト
├── tsconfig.json                   # TypeScript設定
├── vite.config.ts                  # Vite設定（PWA設定含む）
└── vercel.json                     # Vercelデプロイ設定
```

## セットアップ

### 必要な環境

- Node.js 18以上
- npm または yarn

### インストール手順

1. **リポジトリのクローンまたはダウンロード**

2. **依存関係のインストール**

```bash
npm install
```

3. **開発サーバーの起動**

```bash
npm run dev
```

開発サーバーは `http://localhost:3000` で起動します。

4. **本番ビルド**

```bash
npm run build
```

ビルドされたファイルは `dist/` ディレクトリに出力されます。

5. **ビルドのプレビュー**

```bash
npm run preview
```

## 使用方法

### 新規リストの作成

1. 「新規リスト作成」タブを開く
2. 即売会名を入力
3. 以下のいずれかの方法でデータをインポート：
   - **スプレッドシートURL**: GoogleスプレッドシートのURLを入力して「URLからインポート」をクリック
     - シート名「品目表」のM列からR列とW列をインポート
   - **CSVファイル**: CSVファイルを選択してアップロード
     - A列からD列の値が全て入力されている行のみをインポート
     - または、M列から始まる形式（スプレッドシート形式）にも対応
   - **手動入力**: スプレッドシートのM列からR列とW列をコピーして「サークル名」欄に貼り付け（タブ区切りで自動振り分け）
4. 「リストを作成」をクリック

### アイテムの追加

1. 既存のリストを開く
2. 「アイテム追加」タブを開く
3. アイテム情報を入力
4. 「リストに追加」をクリック

### 編集モードでの操作

1. 1日目または2日目のタブを**長押し**（500ms）して編集モードに切り替え
2. 右側の候補リストから購入したいアイテムを選択（複数選択可能）
3. ヘッダーの「選択したアイテムを左列に移動」ボタンをクリック
4. 左側の実行モード表示列でアイテムの順序をドラッグ&ドロップで調整
5. 候補リストでブロックフィルタを使用して、特定のブロックのアイテムのみを表示
6. 選択したアイテムをナンバー順にソート（昇順・降順切り替え可能）
7. 候補リストをブロック名でソート（昇順・降順切り替え可能）

### 実行モードでの操作

1. 1日目または2日目のタブを**長押し**（500ms）して実行モードに切り替え
2. 実行列のアイテムのみが表示されます
3. 各アイテムの購入状態をタップして変更
4. ヘッダーのソートボタンで状態別にフィルタリング
5. 下部のサマリーバーで購入状況を確認

### リストの更新

1. 即売会リスト画面で、更新したいリストを**長押し**
2. 「🔄 アイテム更新」を選択
3. スプレッドシートから最新データを取得（M列から始まる形式を使用）
4. 変更内容を確認（削除・更新・追加のアイテムが表示される）
5. 確認ダイアログで「更新を確定」をクリック
6. スプレッドシートのURLが保存されていない場合は、URL更新ダイアログが表示される

### CSVエクスポート

1. 即売会リスト画面で、エクスポートしたいリストを**長押し**
2. 「Excel形式で出力」を選択
3. CSVファイルがダウンロードされます

## データ管理

### データの保存場所

- すべてのデータはブラウザの**localStorage**に保存されます
- サーバーには送信されません（プライバシー保護）
- データは以下のキーで保存されます：
  - `eventShoppingLists`: アイテムリスト
  - `eventMetadata`: イベントメタデータ（スプレッドシートURL等）
  - `executeModeItems`: 実行モード表示列のアイテムID
  - `dayModes`: 各日のモード（編集/実行）

### データのバックアップ

- 定期的にCSV形式でエクスポートしてバックアップすることを推奨します
- ブラウザのデータをクリアすると、保存されたデータも削除されます

### データの更新ロジック

スプレッドシートから更新する際の照合ルール（M列から始まる形式を使用）：

1. **完全一致**: サークル名・参加日・ブロック・ナンバー・タイトルが全て一致する場合、価格と備考を更新
2. **タイトル変更検出**: サークル名・参加日・ブロック・ナンバーが一致し、タイトルが異なる場合、タイトル・価格・備考を更新
3. **新規追加**: スプレッドシートにあってリストにないアイテムは、候補リストに追加（ソート順を保持）
4. **削除検出**: リストにあってスプレッドシートにないアイテムは削除候補として表示（実行モード列からも削除）

### データ形式の詳細

#### スプレッドシート形式（M列から始まる）

- M列: サークル名
- N列: 参加日（例: 1日目、2日目）
- O列: ブロック（例: A、G）
- P列: ナンバー（例: 01a、03a）
- Q列: タイトル
- R列: 頒布価格（数値）
- W列: 備考

#### CSVエクスポート形式（A列から始まる）

- A列: サークル名
- B列: 参加日
- C列: ブロック
- D列: ナンバー
- E列: タイトル
- F列: 頒布価格
- G列: 購入状態（未購入、購入済、売切、欠席、後回し、遅参）
- H列: 備考
- I列: 列の種類（実行列/候補リスト）
- J列: 列内順番

### データ構造

#### ShoppingItem

```typescript
interface ShoppingItem {
  id: string;
  circle: string;           // サークル名
  eventDate: string;         // 参加日（例: "1日目"）
  block: string;             // ブロック
  number: string;             // ナンバー
  title: string;             // タイトル
  price: number | null;      // 頒布価格
  purchaseStatus: PurchaseStatus;  // 購入状態
  remarks: string;           // 備考
}
```

#### PurchaseStatus

- `None`: 未購入
- `Purchased`: 購入済
- `SoldOut`: 売切
- `Absent`: 欠席
- `Postpone`: 後回し
- `Late`: 遅参

## 対応環境

### モバイル

- **Android 7.0以上**: Chrome、Firefox、Samsung Internet
- **iOS 14以上**: Safari

### デスクトップ

- Chrome（最新版）
- Firefox（最新版）
- Edge（最新版）
- Safari（最新版）

### PWA機能

- ホーム画面への追加が可能
- オフラインでも動作（一度アクセス後）
- ネイティブアプリのような体験

## 開発者向け情報

### 主要な状態管理

アプリケーションは以下の状態を管理しています：

- `eventLists`: 各イベントのアイテムリスト
- `eventMetadata`: イベントのメタデータ（スプレッドシートURL等）
- `executeModeItems`: 実行モード表示列に表示するアイテムID
- `dayModes`: 各日の表示モード（編集/実行）
- `activeEventName`: 現在選択中のイベント名
- `activeTab`: 現在のタブ（eventList/day1/day2/import）
- `sortState`: ソート状態
- `selectedItemIds`: 選択中のアイテムID

### カスタマイズ

- **テーマカラー**: `vite.config.ts` の `theme_color` を変更
- **スタイル**: Tailwind CSSクラスを直接編集
- **PWA設定**: `vite.config.ts` の `VitePWA` 設定を変更
- **色パレット**: `src/components/ShoppingList.tsx` の `colorPalette` 配列を編集して、ブロック値ごとの色をカスタマイズ可能（30色まで対応）

### 実装の詳細

#### ドラッグ&ドロップ機能

- ドラッグ中に画面端（上下150px以内）に近づくと自動的にスクロール
- 同じ列内でのみ移動可能（実行モード列と候補リストは別々に管理）
- 複数選択時は、選択されたアイテム全体が移動

#### 色分けアルゴリズム

- 30色のパレットから、存在するブロック値の数に応じて自動的に色を割り当て
- 色相環を考慮して、同系統の色が連続しないように配置
- 同じブロック値のアイテム同士で隣り合った場合、濃い色と薄い色が交互に表示（縞模様）

#### データの永続化

- すべてのデータはブラウザのlocalStorageに自動保存
- データは即座に保存され、ページをリロードしても状態が保持される
- ブラウザのデータをクリアすると、すべてのデータが失われるため、定期的なCSVエクスポートを推奨

## ライセンス

MIT License

## 注意事項

- データはブラウザのローカルストレージに保存されます
- ブラウザのデータを削除すると、保存されたデータも失われます
- スプレッドシートは公開設定（「リンクを知っている全員が閲覧可」）にする必要があります

## 謝辞

このアプリはGoogle AI StudioとCursorを使用して開発されました。
